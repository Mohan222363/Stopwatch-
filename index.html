<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Stopwatch Web App</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f1724;
            --card: #111827;
            --muted: #9ca3af;
            --accent: #06b6d4;
            --glass: rgba(255, 255, 255, 0.03);
            color-scheme: dark;
            font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
        }

        [data-theme="light"] {
            --bg: #f6f8fb;
            --card: #ffffff;
            --muted: #6b7280;
            --accent: #0891b2;
            --glass: rgba(2, 6, 23, 0.03);
            color-scheme: light;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: linear-gradient(180deg, #071023 0%, #0b1220 100%);
        }

        body[data-theme="light"] {
            background: linear-gradient(180deg, #f7fbff 0%, #eef6ff 100%)
        }

        .wrap {
            min-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px
        }

        .card {
            width: 100%;
            max-width: 820px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 30px rgba(2, 6, 23, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.04);
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 20px;
            align-items: start;
        }

        .display {
            background: var(--card);
            padding: 18px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .time {
            font-size: 48px;
            font-weight: 700;
            letter-spacing: 0.6px;
            color: var(--muted);
            font-variant-numeric: tabular-nums;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center
        }

        button {
            border: 0;
            padding: 10px 14px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            box-shadow: inset 0 -2px 0 rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(90deg, var(--accent), #7c3aed);
            color: white
        }

        .btn-primary:hover {
            filter: brightness(1.1);
        }

        .btn-neutral {
            background: transparent;
            border: 1px solid rgba(0, 0, 0, 0.06);
            color: var(--muted)
        }

        .btn-neutral:hover {
            background: rgba(0, 0, 0, 0.04);
        }

        .btn-danger {
            background: #ef4444;
            color: white
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-ghost {
            background: transparent;
            color: var(--muted)
        }

        .btn-ghost:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .btn-toggle {
            background: transparent;
            border: 1px solid rgba(0, 0, 0, 0.06);
            padding: 8px;
            border-radius: 8px
        }

        .btn-toggle:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .meta {
            display: flex;
            gap: 12px;
            align-items: center;
            color: var(--muted);
            font-size: 13px
        }

        .small {
            font-size: 13px;
            color: var(--muted)
        }

        .panel {
            background: var(--card);
            padding: 18px;
            border-radius: 12px;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.04);
        }

        .laps {
            overflow: auto;
            padding-right: 6px
        }

        .lap {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: transparent;
            border: 1px solid rgba(0, 0, 0, 0.03)
        }

        .lap .num {
            font-weight: 600;
            color: var(--muted)
        }

        .lap .val {
            font-family: monospace;
            font-variant-numeric: tabular-nums
        }

        .badge {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.06)
        }

        footer {
            grid-column: 1/-1;
            color: var(--muted);
            font-size: 13px;
            padding-top: 6px
        }

        /* responsive */
        @media (max-width:820px) {
            .card {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body id="body">
    <div class="wrap">
        <div class="card" role="application" aria-label="Stopwatch application">
            <div class="display">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <div class="meta">Simple • Accurate • Keyboard friendly</div>
                        <div class="small">Press <kbd>Space</kbd> to Start / Pause • <kbd>L</kbd> Lap • <kbd>S</kbd>
                            Split • <kbd>R</kbd> Reset</div>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center">
                        <button id="themeToggle" class="btn-toggle" title="Toggle theme">Toggle Theme</button>
                        <div class="meta">00:00:00.00</div>
                    </div>
                </div>

                <div class="time" id="timeDisplay">00:00:00.00</div>

                <div class="controls" aria-hidden="false">
                    <button id="startBtn" class="btn-primary">Start</button>
                    <button id="lapBtn" class="btn-neutral" disabled>Lap</button>
                    <button id="splitBtn" class="btn-neutral" disabled>Split</button>
                    <button id="pauseBtn" class="btn-ghost" style="display:none">Pause</button>
                    <button id="resetBtn" class="btn-danger" disabled>Reset</button>
                </div>
            </div>

            <div class="panel">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div style="font-weight:700">Laps & Splits</div>
                    <div class="small">Recorded items appear here</div>
                </div>

                <div class="laps" id="lapsContainer" tabindex="0" aria-live="polite">
                    <!-- laps inserted here -->
                </div>

                <div style="margin-top:auto;display:flex;gap:8px;align-items:center">
                    <button id="clearLapsBtn" class="btn-neutral" disabled>Clear</button>
                    <button id="exportBtn" class="btn-neutral" disabled>Export CSV</button>
                </div>
            </div>

            <footer>Built with HTML, CSS & JavaScript — Accurate timing via <code>performance.now()</code>. Laps &
                preferences persist in <code>localStorage</code>.</footer>
        </div>
    </div>
    <script>
        // localStorage keys
        const LS_LAPS = 'stopwatch:laps:v1';
        const LS_THEME = 'stopwatch:theme:v1';

        const timeDisplay = document.getElementById('timeDisplay');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const lapBtn = document.getElementById('lapBtn');
        const splitBtn = document.getElementById('splitBtn');
        const resetBtn = document.getElementById('resetBtn');
        const lapsContainer = document.getElementById('lapsContainer');
        const clearLapsBtn = document.getElementById('clearLapsBtn');
        const exportBtn = document.getElementById('exportBtn');
        const themeToggle = document.getElementById('themeToggle');
        const bodyEl = document.getElementById('body');

        let running = false;
        let startTime = 0;      // when the timer was started (performance.now)
        let elapsed = 0;        // elapsed time in ms when paused or on update
        let rafId = null;       // requestAnimationFrame id
        let laps = [];          // array of {type:'lap'|'split', time:ms, ts:iso}

        // formatting
        function formatTime(ms) {
            const totalCentis = Math.floor(ms / 10);
            const centis = totalCentis % 100;
            const totalSeconds = Math.floor(totalCentis / 100);
            const seconds = totalSeconds % 60;
            const totalMinutes = Math.floor(totalSeconds / 60);
            const minutes = totalMinutes % 60;
            const hours = Math.floor(totalMinutes / 60);
            const pad = (n, len = 2) => String(n).padStart(len, '0');
            return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}.${pad(centis)}`;
        }

        // timing loop
        function update() {
            const now = performance.now();
            elapsed = now - startTime;
            timeDisplay.textContent = formatTime(elapsed);
            rafId = requestAnimationFrame(update);
        }

        function start() {
            if (running) return;
            startTime = performance.now() - elapsed; // resume from elapsed
            running = true;
            rafId = requestAnimationFrame(update);
            startBtn.textContent = 'Running';
            startBtn.disabled = true;
            pauseBtn.style.display = 'inline-block';
            lapBtn.disabled = false;
            splitBtn.disabled = false;
            resetBtn.disabled = false;
        }

        function pause() {
            if (!running) return;
            running = false;
            cancelAnimationFrame(rafId);
            elapsed = performance.now() - startTime;
            startBtn.textContent = 'Start';
            startBtn.disabled = false;
            pauseBtn.style.display = 'none';
        }

        function reset() {
            running = false;
            cancelAnimationFrame(rafId);
            elapsed = 0;
            startTime = 0;
            timeDisplay.textContent = '00:00:00.00';
            laps = [];
            saveLaps();
            renderLaps();
            lapBtn.disabled = true;
            splitBtn.disabled = true;
            resetBtn.disabled = true;
            clearLapsBtn.disabled = true;
            exportBtn.disabled = true;
            startBtn.textContent = 'Start';
            startBtn.disabled = false;
            pauseBtn.style.display = 'none';
        }

        // Lap records time and delta; Split records cumulative time but tagged differently
        function record(type) {
            const current = running ? (performance.now() - startTime) : elapsed;
            const entry = { type: type, time: Math.round(current), ts: new Date().toISOString() };
            laps.unshift(entry); // newest first
            saveLaps();
            renderLaps();
            clearLapsBtn.disabled = false;
            exportBtn.disabled = false;
        }

        function renderLaps() {
            lapsContainer.innerHTML = '';
            if (laps.length === 0) {
                lapsContainer.innerHTML = '<div class="small" style="color:var(--muted)">No laps or splits yet</div>';
                return;
            }
            let prev = null;
            laps.forEach((entry, index) => {
                const lapEl = document.createElement('div');
                lapEl.className = 'lap';
                const num = document.createElement('div');
                num.className = 'num';
                const displayIndex = laps.length - index; // ascending 1..n
                num.textContent = `${entry.type === 'split' ? 'Split' : 'Lap'} ${displayIndex}`;

                const val = document.createElement('div');
                val.className = 'val';
                val.textContent = formatTime(entry.time);

                const diff = document.createElement('div');
                diff.className = 'small';
                if (prev === null) {
                    diff.textContent = '';
                } else {
                    const delta = Math.abs(entry.time - prev);
                    diff.textContent = `Δ ${formatTime(delta)}`;
                }

                const leftWrap = document.createElement('div');
                leftWrap.style.display = 'flex';
                leftWrap.style.flexDirection = 'column';
                leftWrap.appendChild(num);
                leftWrap.appendChild(diff);

                // type badge (kept for future use)
                const badge = document.createElement('div');
                badge.className = 'badge';
                badge.textContent = entry.type.toUpperCase();
                badge.style.marginRight = '8px';
                badge.style.alignSelf = 'center';

                const rightWrap = document.createElement('div');
                rightWrap.style.display = 'flex';
                rightWrap.style.alignItems = 'center';
                rightWrap.appendChild(val);

                lapEl.appendChild(leftWrap);
                lapEl.appendChild(rightWrap);
                lapsContainer.appendChild(lapEl);
                prev = entry.time;
            });
        }

        function clearLaps() {
            laps = [];
            saveLaps();
            renderLaps();
            clearLapsBtn.disabled = true;
            exportBtn.disabled = true;
        }

        function exportCSV() {
            if (laps.length === 0) return;
            // build CSV safely using explicit \n escapes (fixes previous multiline-string bug)
            let csv = 'Type,Lap,Milliseconds,Formatted,Timestamp\n';
            for (let i = laps.length - 1; i >= 0; i--) { // ascending lap numbers
                const lapNum = laps.length - i;
                const entry = laps[i];
                const ms = entry.time;
                const fmt = formatTime(ms);
                // quote formatted time and timestamp to be safe
                csv += `${entry.type},${lapNum},${ms},"${fmt}","${entry.ts}"\n`;
            }
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'stopwatch_laps.csv';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        // localStorage handling
        function saveLaps() {
            try {
                localStorage.setItem(LS_LAPS, JSON.stringify(laps));
            } catch (e) { console.warn('Could not save laps', e) }
        }
        function loadLaps() {
            try {
                const raw = localStorage.getItem(LS_LAPS);
                if (raw) laps = JSON.parse(raw);
            } catch (e) { console.warn('Could not load laps', e) }
        }

        // theme toggle
        function setTheme(theme) {
            if (theme === 'light') {
                bodyEl.setAttribute('data-theme', 'light');
                themeToggle.textContent = 'Light';
            } else {
                bodyEl.removeAttribute('data-theme');
                themeToggle.textContent = 'Dark';
            }
            try { localStorage.setItem(LS_THEME, theme); } catch (e) { }
        }
        function loadTheme() {
            try {
                const t = localStorage.getItem(LS_THEME) || 'dark';
                setTheme(t);
            } catch (e) { setTheme('dark') }
        }

        // Event listeners
        startBtn.addEventListener('click', start);
        pauseBtn.addEventListener('click', pause);
        lapBtn.addEventListener('click', () => record('lap'));
        splitBtn.addEventListener('click', () => record('split'));
        resetBtn.addEventListener('click', reset);
        clearLapsBtn.addEventListener('click', clearLaps);
        exportBtn.addEventListener('click', exportCSV);

        themeToggle.addEventListener('click', () => {
            const isLight = bodyEl.getAttribute('data-theme') === 'light';
            setTheme(isLight ? 'dark' : 'light');
        });

        // Keyboard shortcuts: Space => Start/Pause, L => Lap, S => Split, R => Reset
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                if (running) pause(); else start();
            }
            if (e.key.toLowerCase() === 'l') {
                if (!lapBtn.disabled) record('lap');
            }
            if (e.key.toLowerCase() === 's') {
                if (!splitBtn.disabled) record('split');
            }
            if (e.key.toLowerCase() === 'r') {
                reset();
            }
        });

        // initialize
        loadTheme();
        loadLaps();
        renderLaps();
        if (laps.length) {
            clearLapsBtn.disabled = false;
            exportBtn.disabled = false;
        }
    </script>
</body>

</html>